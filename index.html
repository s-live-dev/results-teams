<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S-LIVE Results - 団体戦</title>
    
    <!-- Tailwind CSSの読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesomeの読み込み -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fontsの読み込み -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=BIZ+UDGothic:wght@400;700&family=Noto+Sans+JP:wght@400;700&family=Ramabhadra&display=swap" rel="stylesheet">

    <style>
        /* S-LIVEスタイル */
        body {
            font-family: 'BIZ UDGothic', 'Noto Sans JP', sans-serif;
            background: linear-gradient(270deg, #1e2569, #19115d, #2b1364, #2d0535);
            color: #F3F4F6;
            text-shadow: 0.1vh 0.1vh 0.1vh rgba(0, 0, 0, 0.5);
            overflow-x: hidden;
        }
        
        /* オリジナルのハイスコアカラーリング */
        .hl23 {
            color: RGB(101, 255, 255);
        }

        .hl24 {
            color: RGB(255, 153, 229);
            text-decoration: underline solid;
        }

        .hl25 {
            color: RGB(255, 255, 101);
            text-decoration: underline double;
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .tab.active {
            background-color: #3B82F6;
            color: white;
            border-bottom-color: transparent;
        }
        
        ::-webkit-scrollbar { display: none; }
        -ms-overflow-style: none;
        scrollbar-width: none;

        .header-gradient {
            background-image: radial-gradient(farthest-side at 50% 0%, rgb(80 91 208 / 50%), rgba(0, 0, 0, 0));
        }
        
        /* 種目バッジ画像 */
        .event-badge-img {
            height: 1rem;
            margin-right: 0.5rem;
            vertical-align: middle;
            border-radius: 0.25rem;
            padding: 0.125rem;
        }
        
        /* 種目別の枠線 - 明度調整 */
        .event-badge-trap {
            border: 1.5px solid #c855e3;
        }
        
        .event-badge-skeet {
            border: 1.5px solid #eebf35;
        }
        
        .event-badge-overall {
            border: 1.5px solid #22c55e;
        }
        
        /* 団体スコア内の種目バッジ */
        .team-score-badge {
            height: 0.875rem;
            margin-right: 0.25rem;
            vertical-align: middle;
            border-radius: 0.25rem;
            padding: 0.125rem;
        }
        
        /* 団体スコア内の種目別枠線 - 明度調整 */
        .team-score-badge.trap {
            border: 1.5px solid #c855e3;
        }
        
        .team-score-badge.skeet {
            border: 1.5px solid #eebf35;
        }
        
        /* スマホ版：フッター重複防止マージン - フッター高さの1.5倍に調整 */
        @media (max-width: 1023px) {
            .fullscreen-container {
                padding: 0.5rem;
                padding-bottom: 15rem; /* フッター高さの1.5倍のマージンを確保 */
            }
            
            /* スマホ版のメインコンテンツにも下部マージンを確保 */
            main {
                padding-bottom: 3rem !important;
                margin-bottom: 3rem;
            }
        }

        /* PC版：全画面デジタルサイネージモード */
        @media (min-width: 1024px) {
            body {
                height: 100vh;
                overflow: hidden;
            }
            
            .tab-content {
                display: block !important;
            }
            
            /* ヘッダー・フッターを非表示 */
            .mobile-only {
                display: none !important;
            }
            
            /* 全画面活用 */
            .fullscreen-container {
                height: 100vh;
                padding: 0.5rem;
                margin: 0;
                max-width: 100%;
            }
            
            /* PC版でアコーディオンを常時開く */
            .accordion-content {
                max-height: none !important;
                overflow: visible !important;
            }
            .accordion-chevron {
                transform: rotate(180deg);
            }
            
            /* PC版フォントサイズ拡大 */
            .team-header {
                font-size: 1.25rem !important;
            }
            .team-rank {
                font-size: 1.5rem !important;
            }
            .team-name {
                font-size: 1.25rem !important;
            }
            .team-total {
                font-size: 1.75rem !important;
            }
            .player-name {
                font-size: 1rem !important;
            }
            .player-score {
                font-size: 1rem !important;
            }
            .section-title {
                font-size: 1.5rem !important;
                margin-bottom: 0.5rem !important;
            }
        }

        /* スマホ版：通常UI */
        @media (max-width: 1023px) {
            body {
                min-height: 100vh;
            }
            
            .fullscreen-container {
                padding: 0.5rem;
            }
            
            .desktop-only {
                display: none !important;
            }
        }
    </style>
</head>
<body class="flex flex-col">

    <!-- ローディング表示 -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex justify-center items-center z-50">
        <i class="fa-solid fa-spinner fa-spin text-4xl text-white"></i>
    </div>

    <!-- スマホ版のみ：ヘッダー情報 -->
    <header class="mobile-only header-gradient p-2 mb-2 mx-2 mt-2 flex items-center justify-center space-x-4">
        <img id="event-flag" src="" alt="Flag" class="h-8 rounded-full hidden">
        <h1 id="event-name" class="text-xl font-bold text-white text-center" style="text-shadow: 0.4vh 0.4vh 0.4vh rgba(0, 0, 0, 0.5);"></h1>
    </header>

    <div class="fullscreen-container flex-grow">
        
        <!-- スマホ版のみ：タブナビゲーション -->
        <div class="mobile-only mb-2 border-b border-white/20">
            <nav class="flex flex-wrap -mb-px" aria-label="Tabs">
                <button onclick="changeTab('team-trap')" class="tab active w-1/3 text-center py-2 px-1 border-b-2 border-transparent font-medium text-xs hover:bg-white/10 transition">
                    トラップ
                </button>
                <button onclick="changeTab('team-skeet')" class="tab w-1/3 text-center py-2 px-1 border-b-2 border-transparent font-medium text-xs hover:bg-white/10 transition">
                    スキート
                </button>
                <button onclick="changeTab('team-overall')" class="tab w-1/3 text-center py-2 px-1 border-b-2 border-transparent font-medium text-xs hover:bg-white/10 transition">
                    総合成績
                </button>
            </nav>
        </div>

        <!-- コンテンツエリア -->
        <main class="pb-2 lg:pb-0 lg:h-full">
            <!-- スマホ：タブ切り替え / PC：3カラム全画面表示 -->
            <div class="lg:grid lg:grid-cols-3 lg:gap-2 lg:h-full">
                
                <!-- トラップ種目団体セクション -->
                <div id="team-trap" class="tab-content lg:!block lg:h-full lg:overflow-y-auto">
                    <h2 class="section-title desktop-only text-lg font-bold mb-1" style="color: #b219e3;">
                        <img src="https://s-live.org/wp-content/plugins/s-live/resource/TRAP.png" class="event-badge-img event-badge-trap inline">トラップ種目 団体
                    </h2>
                    <div id="team-trap-event" class="space-y-1"></div>
                </div>

                <!-- スキート種目団体セクション -->
                <div id="team-skeet" class="tab-content hidden lg:!block lg:h-full lg:overflow-y-auto">
                    <h2 class="section-title desktop-only text-lg font-bold mb-1" style="color: #eebf35;">
                        <img src="https://s-live.org/wp-content/plugins/s-live/resource/SKEET.png" class="event-badge-img event-badge-skeet inline">スキート種目 団体
                    </h2>
                    <div id="team-skeet-event" class="space-y-1"></div>
                </div>

                <!-- トラップ種目団体セクション -->
                <div id="team-trap" class="tab-content lg:!block lg:h-full lg:overflow-y-auto">
                    <h2 class="section-title desktop-only text-lg font-bold mb-1" style="color: #c855e3;">
                        <img src="https://s-live.org/wp-content/plugins/s-live/resource/TRAP.png" class="event-badge-img event-badge-trap inline">トラップ種目 団体
                    </h2>
                    <div id="team-trap-event" class="space-y-1"></div>
                </div>

                <!-- スキート種目団体セクション -->
                <div id="team-skeet" class="tab-content hidden lg:!block lg:h-full lg:overflow-y-auto">
                    <h2 class="section-title desktop-only text-lg font-bold mb-1" style="color: #eebf35;">
                        <img src="https://s-live.org/wp-content/plugins/s-live/resource/SKEET.png" class="event-badge-img event-badge-skeet inline">スキート種目 団体
                    </h2>
                    <div id="team-skeet-event" class="space-y-1"></div>
                </div>

                <!-- 総合団体セクション -->
                <div id="team-overall" class="tab-content hidden lg:!block lg:h-full lg:overflow-y-auto">
                    <h2 class="section-title desktop-only text-lg font-bold mb-1 text-green-400">
                        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjQwIiB2aWV3Qm94PSIwIDAgMTAwIDQwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgogIDxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iNDAiIHJ4PSI4IiByeT0iOCIgZmlsbD0iIzIyYzU1ZSIvPgogIDx0ZXh0IHg9IjUwIiB5PSIyNSIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBmb250LXdlaWdodD0iYm9sZCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0id2hpdGUiPk9WRVJBTEM8L3RleHQ+CiAgPGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoOCwgOCkiPgogICAgPHBvbHlnb24gcG9pbnRzPSI0LDggOCw0IDEyLDggMTYsNCAyMCw4IDIwLDIwIDQsMjAiIGZpbGw9IndoaXRlIiBvcGFjaXR5PSIwLjgiLz4KICAgIDxjaXJjbGUgY3g9IjgiIGN5PSI2IiByPSIxIiBmaWxsPSIjZmJiZjI0Ii8+CiAgICA8Y2lyY2xlIGN4PSIxMiIgY3k9IjUiIHI9IjEuMiIgZmlsbD0iI2ZiYmYyNCIvPgogICAgPGNpcmNsZSBjeD0iMTYiIGN5PSI2IiByPSIxIiBmaWxsPSIjZmJiZjI0Ii8+CiAgPC9nPgo8L3N2Zz4=" class="event-badge-img event-badge-overall inline">総合団体
                    </h2>
                    <div id="team-overall-results" class="space-y-1"></div>
                </div>
                
            </div>
        </main>
    </div>

    <!-- スマホ版のみ：フッター -->
    <footer class="mobile-only bg-black/30 p-1 fixed bottom-0 left-0 right-0 text-white/80">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div class="text-left">
                    <div id="event-place" class="text-sm font-bold"></div>
                    <div id="event-weather" class="text-xs"></div>
                </div>
            </div>
            <div class="flex items-center">
                <img id="qr-code" src="" class="h-12 w-12 bg-white p-0.5">
            </div>
        </div>
    </footer>

    <script>
        // スコアカラーリング関数
        function getScoreClass(score) {
            switch (score) {
                case 23: return 'hl23';
                case 24: return 'hl24';
                case 25: return 'hl25';
                default: return '';
            }
        }
        function renderTeamEvent(data, targetId, color) {
            const container = document.getElementById(targetId);
            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center p-4">データがありません。</p>';
                return;
            }
            container.innerHTML = data.map((team) => `
                <div class="bg-white/10 backdrop-blur-sm rounded-lg shadow-lg border border-white/20">
                    <button onclick="toggleAccordion(this)" class="w-full flex justify-between items-center p-2 text-left font-bold">
                        <div class="flex items-center">
                            <span class="team-rank w-8 text-center text-lg">${team.rank}</span>
                            <span class="team-name flex-1">${team.name}</span>
                        </div>
                        <div class="flex items-center">
                            <span class="team-total text-xl mr-4" style="color: ${color};">${team.total}</span>
                            <i class="fa-solid fa-chevron-down accordion-chevron transition-transform duration-300"></i>
                        </div>
                    </button>
                    <div class="accordion-content">
                        <div class="px-2 overflow-x-auto">
                            <table class="w-full text-sm min-w-[300px]" style="table-layout: fixed;">
                                <colgroup>
                                    <col style="width: 5%;">   <!-- 順位 -->
                                    <col style="width: 45%;">  <!-- 選手名 -->
                                    <col style="width: 9%;">   <!-- R1 -->
                                    <col style="width: 9%;">   <!-- R2 -->
                                    <col style="width: 9%;">   <!-- R3 -->
                                    <col style="width: 9%;">   <!-- R4 -->
                                    <col style="width: 14%;">  <!-- 合計 -->
                                </colgroup>
                                <tbody class="divide-y divide-white/20">
                                    ${team.players.map(p => `
                                        <tr class="text-gray-200">
                                            <td class="py-0.5 player-score">${p.rank}</td>
                                            <td class="py-0.5 player-name">${p.name}</td>
                                            <td class="text-right py-0.5 player-score ${getScoreClass(p.r1)}">${p.r1}</td>
                                            <td class="text-right py-0.5 player-score ${getScoreClass(p.r2)}">${p.r2}</td>
                                            <td class="text-right py-0.5 player-score ${getScoreClass(p.r3)}">${p.r3}</td>
                                            <td class="text-right py-0.5 player-score ${getScoreClass(p.r4)}">${p.r4}</td>
                                            <td class="text-right py-0.5 pr-2 font-bold player-score" style="color: ${color};">${p.total}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderTeamOverall(data, targetId) {
            const container = document.getElementById(targetId);
            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center p-4">データがありません。</p>';
                return;
            }
            container.innerHTML = data.map(team => `
                <div class="bg-white/10 backdrop-blur-sm rounded-lg shadow-lg border border-white/20">
                    <button onclick="toggleAccordion(this)" class="w-full flex justify-between items-center p-2 text-left font-bold">
                        <div class="flex items-center">
                            <span class="team-rank w-8 text-center text-lg">${team.rank}</span>
                            <span class="team-name flex-1">${team.name}</span>
                        </div>
                        <div class="flex items-center">
                            <span class="team-total text-xl text-green-400 mr-4">${team.overallTotal}</span>
                            <i class="fa-solid fa-chevron-down accordion-chevron transition-transform duration-300"></i>
                        </div>
                    </button>
                    <div class="accordion-content">
                        <div class="px-2 pb-2 grid grid-cols-1 md:grid-cols-2 gap-2">
                            <div>
                                <h4 class="font-bold mb-1 text-sm" style="color: #c855e3;">
                                    <img src="https://s-live.org/wp-content/plugins/s-live/resource/TRAP.png" class="team-score-badge trap inline">
                                    トラップ: ${team.trapTotal}点
                                </h4>
                                <ul class="text-xs space-y-0.5">
                                    ${team.trapPlayers.map(p => `<li class="flex justify-between player-name"><span>${p.rank}. ${p.name}</span><span class="font-semibold player-score" style="color: #c855e3;">${p.total}</span></li>`).join('')}
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-bold mb-1 text-sm" style="color: #eebf35;">
                                    <img src="https://s-live.org/wp-content/plugins/s-live/resource/SKEET.png" class="team-score-badge skeet inline">
                                    スキート: ${team.skeetTotal}点
                                </h4>
                                <ul class="text-xs space-y-0.5">
                                    ${team.skeetPlayers.map(p => `<li class="flex justify-between player-name"><span>${p.rank}. ${p.name}</span><span class="font-semibold player-score" style="color: #eebf35;">${p.total}</span></li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function renderHeaderAndFooter(info) {
            if (!info) return;
            
            // スマホ版のみ更新
            const eventName = document.getElementById('event-name');
            if (eventName) eventName.textContent = info.name;
            
            if (info.flagUrl) {
                const flagImg = document.getElementById('event-flag');
                if (flagImg) {
                    flagImg.src = info.flagUrl;
                    flagImg.classList.remove('hidden');
                }
            }
            
            const eventPlace = document.getElementById('event-place');
            if (eventPlace) eventPlace.textContent = info.place;
            
            const eventWeather = document.getElementById('event-weather');
            if (eventWeather) eventWeather.innerHTML = info.weather;
            
            const qrCode = document.getElementById('qr-code');
            if (qrCode) qrCode.src = info.qrCodeUrl;
        }

        // --- イベントハンドラ ---
        function changeTab(tabName) {
            // PC表示では何もしない（3カラム常時表示）
            if (window.innerWidth >= 1024) return;
            
            // スマホ表示のみタブ切り替え
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.remove('hidden');
            document.querySelector(`button[onclick="changeTab('${tabName}')"]`).classList.add('active');
        }

        function toggleAccordion(buttonElement) {
            // PC表示では何もしない（常に開いた状態）
            if (window.innerWidth >= 1024) return;
            
            const content = buttonElement.nextElementSibling;
            const icon = buttonElement.querySelector('i');
            if (content.style.maxHeight) {
                content.style.maxHeight = null;
                icon.classList.remove('rotate-180');
            } else {
                content.style.maxHeight = content.scrollHeight + "px";
                icon.classList.add('rotate-180');
            }
        }
        
        function updateClock() {
            // 時計機能を削除（フッターから時計を除去したため）
        }

        // ウィンドウリサイズ時の表示調整
        function handleResize() {
            if (window.innerWidth >= 1024) {
                // PC表示：3カラム全表示
                document.getElementById('team-trap').classList.remove('hidden');
                document.getElementById('team-skeet').classList.remove('hidden');
                document.getElementById('team-overall').classList.remove('hidden');
                
                // アコーディオンを全て開く
                document.querySelectorAll('.accordion-content').forEach(content => {
                    content.style.maxHeight = 'none';
                });
                document.querySelectorAll('.accordion-chevron').forEach(icon => {
                    icon.classList.add('rotate-180');
                });
            } else {
                // スマホ表示：アクティブなタブのみ表示
                const activeTab = document.querySelector('.tab.active');
                if (activeTab) {
                    const tabName = activeTab.getAttribute('onclick').match(/'([^']+)'/)[1];
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                    document.getElementById(tabName).classList.remove('hidden');
                }
                
                // アコーディオンを初期状態に戻す
                document.querySelectorAll('.accordion-content').forEach(content => {
                    content.style.maxHeight = null;
                });
                document.querySelectorAll('.accordion-chevron').forEach(icon => {
                    icon.classList.remove('rotate-180');
                });
            }
        }

        // --- データ取得と画面描画 ---
        function fetchData() {
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.classList.remove('hidden');

            const spreadsheetId = '<?!= s ?>';

            google.script.run
                .withSuccessHandler(data => {
                    if (data.error) {
                        console.error("Error from GAS: ", data.error);
                        loadingOverlay.innerHTML = `<p class="text-red-500 p-4">データ取得エラー: ${data.error}</p>`;
                        return;
                    }
                    renderHeaderAndFooter(data.eventInfo);
                    renderTeamEvent(data.teamEvent.trap, 'team-trap-event', '#c855e3');
                    renderTeamEvent(data.teamEvent.skeet, 'team-skeet-event', '#eebf35');
                    renderTeamOverall(data.teamOverall, 'team-overall-results');
                    
                    // データ表示後にレスポンシブ処理を実行
                    handleResize();
                    
                    loadingOverlay.classList.add('hidden');
                })
                .withFailureHandler(error => {
                    console.error("Error fetching data: ", error);
                    loadingOverlay.innerHTML = '<p class="text-red-500 p-4">データ取得エラー</p>';
                })
                .getTeamData(spreadsheetId);
        }

        // --- 初期化処理 ---
        document.addEventListener('DOMContentLoaded', () => {
            handleResize(); // 初期表示調整
            fetchData(); // 初回データ取得
            setInterval(fetchData, 600000); // 10分ごとにデータを更新
        });

        // リサイズイベントリスナー
        window.addEventListener('resize', handleResize);

    </script>
</body>
</html>