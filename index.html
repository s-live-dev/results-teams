<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S-LIVE Results - 団体戦</title>
    
    <!-- Tailwind CSSの読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesomeの読み込み -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fontsの読み込み -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=BIZ+UDGothic:wght@400;700&family=Noto+Sans+JP:wght@400;700&family=Ramabhadra&display=swap" rel="stylesheet">

    <style>
        /* オリジナルのS-LIVEのスタイルを再現 */
        body {
            font-family: 'BIZ UDGothic', 'Noto Sans JP', sans-serif;
            background: linear-gradient(270deg, #1e2569, #19115d, #2b1364, #2d0535);
            color: #F3F4F6;
            text-shadow: 0.1vh 0.1vh 0.1vh rgba(0, 0, 0, 0.5);
            height: 100vh;
            overflow-x: hidden;
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .tab.active {
            background-color: #3B82F6;
            color: white;
            border-bottom-color: transparent;
        }
        
        ::-webkit-scrollbar { display: none; }
        -ms-overflow-style: none;
        scrollbar-width: none;

        .header-gradient {
            background-image: radial-gradient(farthest-side at 50% 0%, rgb(80 91 208 / 50%), rgba(0, 0, 0, 0));
        }
        
        footer {
            font-family: 'Ramabhadra', sans-serif;
        }
    </style>
</head>
<body class="flex flex-col">

    <!-- ローディング表示 -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex justify-center items-center z-50">
        <i class="fa-solid fa-spinner fa-spin text-4xl text-white"></i>
    </div>

    <div class="container mx-auto p-2 md:p-4 flex-grow">
        
        <!-- ヘッダー情報 -->
        <header class="header-gradient bg-black/50 p-3 rounded-lg shadow-lg mb-4 flex items-center justify-center space-x-4">
            <img id="event-flag" src="" alt="Flag" class="h-10 rounded-full hidden">
            <h1 id="event-name" class="text-2xl md:text-3xl font-bold text-white text-center" style="text-shadow: 0.4vh 0.4vh 0.4vh rgba(0, 0, 0, 0.5);"></h1>
        </header>

        <!-- タブナビゲーション -->
        <div class="mb-4 border-b border-white/20">
            <nav class="flex flex-wrap -mb-px" aria-label="Tabs">
                <button onclick="changeTab('team-event')" class="tab active w-1/3 md:w-auto text-center py-3 px-2 border-b-2 border-transparent font-medium text-sm md:text-base hover:bg-white/10 transition">
                    競技別団体
                </button>
                <button onclick="changeTab('team-overall')" class="tab w-1/3 md:w-auto text-center py-3 px-2 border-b-2 border-transparent font-medium text-sm md:text-base hover:bg-white/10 transition">
                    総合団体
                </button>
                <button onclick="changeTab('individual')" class="tab w-1/3 md:w-auto text-center py-3 px-2 border-b-2 border-transparent font-medium text-sm md:text-base hover:bg-white/10 transition">
                    個人成績
                </button>
            </nav>
        </div>

        <!-- コンテンツエリア -->
        <main class="pb-24">
            <div id="team-event" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div>
                        <h2 class="text-xl font-bold mb-3" style="color: #eebf35;"><i class="fa-solid fa-bullseye mr-2"></i>トラップ種目 団体</h2>
                        <div id="team-trap-event" class="space-y-2"></div>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold mb-3" style="color: #b219e3;"><i class="fa-solid fa-compact-disc mr-2"></i>スキート種目 団体</h2>
                        <div id="team-skeet-event" class="space-y-2"></div>
                    </div>
                </div>
            </div>

            <div id="team-overall" class="tab-content hidden">
                <h2 class="text-xl font-bold mb-3 text-green-400"><i class="fa-solid fa-trophy mr-2"></i>総合団体</h2>
                <div id="team-overall-results" class="space-y-2"></div>
            </div>
            
            <div id="individual" class="tab-content hidden">
                 <h2 class="text-xl font-bold mb-3 text-gray-300"><i class="fa-solid fa-user mr-2"></i>個人成績</h2>
                 <p class="text-gray-400 text-center p-8">（ここに既存の個人成績表示を統合します）</p>
            </div>
        </main>
    </div>

    <!-- フッター -->
    <footer class="bg-black/30 p-2 fixed bottom-0 left-0 right-0 text-white/80">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <div class="text-left">
                    <div id="event-place" class="text-lg font-bold"></div>
                    <div id="event-datetime" class="text-xs"></div>
                    <div id="event-weather" class="text-xs"></div>
                </div>
                <div class="text-left text-sm">
                    <div id="status-trap"></div>
                    <div id="status-skeet"></div>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                 <div class="text-right text-xs">
                    <div id="event-update-time"></div>
                    <div>Powered by "S-LIVE"</div>
                </div>
                <div id="current-time" class="text-2xl font-sans"></div>
                <img id="sponsor-logo" src="https://s-live.org/wp-content/plugins/s-live/resource/spo/spo_logos_x2bl.png" class="h-8 hidden md:block">
                <img id="qr-code" src="" class="h-12 w-12 bg-white p-0.5">
            </div>
        </div>
    </footer>


    <script>
        // --- DOM生成関数 ---
        function renderTeamEvent(data, targetId, color) {
            const container = document.getElementById(targetId);
            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center p-4">データがありません。</p>';
                return;
            }
            container.innerHTML = data.map((team) => `
                <div class="bg-black/30 rounded-lg shadow">
                    <button onclick="toggleAccordion(this)" class="w-full flex justify-between items-center p-3 text-left font-bold">
                        <div class="flex items-center">
                            <span class="w-8 text-center text-lg">${team.rank}</span>
                            <span class="flex-1">${team.name}</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-xl mr-4" style="color: ${color};">${team.total}</span>
                            <i class="fa-solid fa-chevron-down transition-transform duration-300"></i>
                        </div>
                    </button>
                    <div class="accordion-content">
                        <div class="p-3 pt-0 overflow-x-auto">
                            <table class="w-full text-sm min-w-[300px]">
                                <thead class="text-white/50">
                                    <tr>
                                        <th class="text-left font-normal w-1/6 py-1">順位</th>
                                        <th class="text-left font-normal w-2/6 py-1">選手名</th>
                                        <th class="text-right font-normal py-1">R1</th>
                                        <th class="text-right font-normal py-1">R2</th>
                                        <th class="text-right font-normal py-1">R3</th>
                                        <th class="text-right font-normal py-1">R4</th>
                                        <th class="text-right font-normal py-1 pr-2">合計</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-white/20">
                                    ${team.players.map(p => `
                                        <tr class="text-gray-200">
                                            <td class="py-1">${p.rank}</td>
                                            <td class="py-1">${p.name}</td>
                                            <td class="text-right py-1">${p.r1}</td>
                                            <td class="text-right py-1">${p.r2}</td>
                                            <td class="text-right py-1">${p.r3}</td>
                                            <td class="text-right py-1">${p.r4}</td>
                                            <td class="text-right py-1 pr-2 font-bold" style="color: ${color};">${p.total}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderTeamOverall(data, targetId) {
            const container = document.getElementById(targetId);
            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center p-4">データがありません。</p>';
                return;
            }
            container.innerHTML = data.map(team => `
                <div class="bg-black/30 rounded-lg shadow">
                    <button onclick="toggleAccordion(this)" class="w-full flex justify-between items-center p-3 text-left font-bold">
                        <div class="flex items-center">
                            <span class="w-8 text-center text-lg">${team.rank}</span>
                            <span class="flex-1">${team.name}</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-xl text-green-400 mr-4">${team.overallTotal}</span>
                            <i class="fa-solid fa-chevron-down transition-transform duration-300"></i>
                        </div>
                    </button>
                    <div class="accordion-content">
                        <div class="p-3 pt-0 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-bold mb-1" style="color: #eebf35;">トラップ: ${team.trapTotal}点</h4>
                                <ul class="text-sm space-y-1">
                                    ${team.trapPlayers.map(p => `<li class="flex justify-between"><span>${p.rank}. ${p.name}</span><span class="font-semibold" style="color: #eebf35;">${p.total}</span></li>`).join('')}
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-bold mb-1" style="color: #b219e3;">スキート: ${team.skeetTotal}点</h4>
                                <ul class="text-sm space-y-1">
                                    ${team.skeetPlayers.map(p => `<li class="flex justify-between"><span>${p.rank}. ${p.name}</span><span class="font-semibold" style="color: #b219e3;">${p.total}</span></li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function renderHeaderAndFooter(info) {
            if (!info) return;
            document.getElementById('event-name').textContent = info.name;
            if (info.flagUrl) {
                const flagImg = document.getElementById('event-flag');
                flagImg.src = info.flagUrl;
                flagImg.classList.remove('hidden');
            }
            document.getElementById('event-place').textContent = info.place;
            document.getElementById('event-datetime').textContent = `${info.date} ${info.days}`;
            document.getElementById('event-weather').innerHTML = info.weather;
            document.getElementById('event-update-time').textContent = info.lastUpdate;
            document.getElementById('status-trap').textContent = `TRAP: ${info.status.trap}`;
            document.getElementById('status-skeet').textContent = `SKEET: ${info.status.skeet}`;
            document.getElementById('qr-code').src = info.qrCodeUrl;
        }

        // --- イベントハンドラ ---
        function changeTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.remove('hidden');
            document.querySelector(`button[onclick="changeTab('${tabName}')"]`).classList.add('active');
        }

        function toggleAccordion(buttonElement) {
            const content = buttonElement.nextElementSibling;
            const icon = buttonElement.querySelector('i');
            if (content.style.maxHeight) {
                content.style.maxHeight = null;
                icon.classList.remove('rotate-180');
            } else {
                content.style.maxHeight = content.scrollHeight + "px";
                icon.classList.add('rotate-180');
            }
        }
        
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
            document.getElementById('current-time').textContent = timeString;
        }

        // --- データ取得と画面描画 ---
        function fetchData() {
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.classList.remove('hidden');

            // GASから渡されたパラメータを受け取る
            const spreadsheetId = '<?!= s ?>';

            google.script.run
                .withSuccessHandler(data => {
                    // GAS側でエラーがあった場合の処理
                    if (data.error) {
                        console.error("Error from GAS: ", data.error);
                        loadingOverlay.innerHTML = `<p class="text-red-500 p-4">データ取得エラー: ${data.error}</p>`;
                        return;
                    }
                    renderHeaderAndFooter(data.eventInfo);
                    renderTeamEvent(data.teamEvent.trap, 'team-trap-event', '#ffbf00');
                    renderTeamEvent(data.teamEvent.skeet, 'team-skeet-event', '#00ff3f');
                    renderTeamOverall(data.teamOverall, 'team-overall-results');
                    loadingOverlay.classList.add('hidden');
                })
                .withFailureHandler(error => {
                    console.error("Error fetching data: ", error);
                    loadingOverlay.innerHTML = '<p class="text-red-500 p-4">データ取得エラー</p>';
                })
                // getTeamData関数にスプレッドシートIDのみを渡す
                .getTeamData(spreadsheetId);
        }

        // --- 初期化処理 ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchData(); // 初回データ取得
            setInterval(fetchData, 60000); // 60秒ごとにデータを更新

            updateClock();
            setInterval(updateClock, 1000); // 1秒ごとに時計を更新
        });

    </script>
</body>
</html>
